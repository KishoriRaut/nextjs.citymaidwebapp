<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Your Profile - City Maid Services</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // Configure Tailwind to include custom colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'whatsapp': {
                            light: '#e5ddd5',
                            primary: '#128c7e',
                            'text-primary': '#3b4a54',
                            'text-secondary': '#667781',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="font-sans bg-whatsapp-light text-whatsapp-text-primary">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-whatsapp sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="../index.html" class="text-2xl font-semibold text-whatsapp-primary">CITYMAID</a>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="../index.html" class="text-whatsapp-text-primary hover:text-whatsapp-primary text-sm font-medium transition-colors">Home</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Profile Update Form -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 md:p-8 border border-gray-100">
            <h1 class="text-2xl font-semibold text-whatsapp-text-primary mb-8 pb-4 border-b border-gray-200">Update Your Profile</h1>
            
            <form id="profileForm" class="space-y-8">
                <!-- Profile Photo -->
                <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-whatsapp-text-primary">Profile Photo *</label>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <div class="w-32 h-32 rounded-full bg-white flex items-center justify-center overflow-hidden border-2 border-whatsapp-primary">
                                <img id="profilePhotoPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150' fill='none'%3E%3Crect width='150' height='150' fill='%23F0F2F5'/%3E%3Cpath d='M75 75C83.2843 75 90 68.2843 90 60C90 51.7157 83.2843 45 75 45C66.7157 45 60 51.7157 60 60C60 68.2843 66.7157 75 75 75Z' fill='%23667781'/%3E%3Cpath d='M75 82.5C58.4315 82.5 45 95.9315 45 112.5V120H105V112.5C105 95.9315 91.5685 82.5 75 82.5Z' fill='%23667781'/%3E%3C/svg%3E" alt="Profile Photo" 
                                    class="w-32 h-32 object-cover">
                                <i id="placeholderIcon" class="fas fa-user-circle text-whatsapp-text-secondary text-5xl absolute"></i>
                            </div>
                            <input type="file" id="profilePhoto" accept="image/*" class="hidden" title="Upload profile photo">
                            <button type="button" onclick="document.getElementById('profilePhoto').click()" 
                                class="absolute bottom-0 right-0 bg-whatsapp-primary text-white p-3 rounded-full hover:bg-whatsapp-secondary shadow-lg transition-all duration-200" title="Upload photo">
                                <i class="fas fa-camera text-lg"></i>
                            </button>
                        </div>
                        <div class="space-y-2">
                            <p class="text-sm text-whatsapp-text-primary">Click the camera icon to upload your photo</p>
                            <p class="text-xs text-whatsapp-text-secondary">Upload a clear face photo to increase your chances of getting hired</p>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="space-y-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <h2 class="text-lg font-semibold text-whatsapp-text-primary pb-2 border-b border-gray-200">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="fullName" class="block text-sm font-medium text-whatsapp-text-primary mb-2">Full Name *</label>
                            <input type="text" id="fullName" name="fullName" required minlength="3" maxlength="50"
                            placeholder="Enter your full name as per documents"
                                pattern="[A-Za-z\s]+" title="Please enter a valid name (letters and spaces only)"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                            <p class="text-xs text-whatsapp-text-secondary mt-1">3-50 characters, letters only</p>
                    </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="ageGroup" class="block text-sm font-medium text-whatsapp-text-primary">Age Group *</label>
                        <select id="ageGroup" name="ageGroup" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                            <option value="">Select Age Group</option>
                                <option value="18-25">18-25 years</option>
                                <option value="25-35">25-35 years</option>
                                <option value="35-45">35-45 years</option>
                                <option value="45+">45+ years</option>
                        </select>
                    </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="gender" class="block text-sm font-medium text-whatsapp-text-primary">Gender *</label>
                        <select id="gender" name="gender" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                            <option value="">Select Gender</option>
                            <option value="Female">Female</option>
                            <option value="Male">Male</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="maritalStatus" class="block text-sm font-medium text-whatsapp-text-primary">Marital Status *</label>
                        <select id="maritalStatus" name="maritalStatus" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                            <option value="">Select Status</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Widowed">Widowed</option>
                        </select>
                    </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="space-y-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <h2 class="text-lg font-semibold text-whatsapp-text-primary pb-2 border-b border-gray-200">Contact Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="email" class="block text-sm font-medium text-whatsapp-text-primary">Email *</label>
                            <input type="email" id="email" name="email" required
                                placeholder="Enter your active email address"
                                pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                                title="Please enter a valid email address"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="phone" class="block text-sm font-medium text-whatsapp-text-primary">Phone Number *</label>
                            <input type="tel" id="phone" name="phone" required
                                placeholder="Enter your active phone number"
                                pattern="[0-9]{10}" title="Please enter a valid 10-digit phone number"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                            <p class="text-xs text-whatsapp-text-secondary mt-1">10 digits only</p>
                        </div>
                    </div>
                </div>

                <!-- Work Information -->
                <div class="space-y-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <h2 class="text-lg font-semibold text-whatsapp-text-primary pb-2 border-b border-gray-200">Work Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="experience" class="block text-sm font-medium text-whatsapp-text-primary">Years of Experience *</label>
                            <select id="experience" name="experience" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="0">No experience/Freshers</option>
                                <option value="1">1+ year</option>
                                <option value="2">2+ years</option>
                                <option value="3">3+ years</option>
                                <option value="5">5+ years</option>
                                <option value="10">10+ years</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="availableFrom" class="block text-sm font-medium text-whatsapp-text-primary">Available From *</label>
                            <select id="availableFrom" name="availableFrom" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Availability</option>
                                <option value="Immediate">Immediate</option>
                                <option value="Within a week">Within a week</option>
                                <option value="Within 2 weeks">Within 2 weeks</option>
                                <option value="Within a month">Within a month</option>
                                <option value="After a month">After a month</option>
                            </select>
                            <p class="text-xs text-whatsapp-text-secondary mt-1">When can you start working?</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="preferredTime" class="block text-sm font-medium text-whatsapp-text-primary">Preferred Working Time *</label>
                            <select id="preferredTime" name="preferredTime" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Preferred Time</option>
                                <option value="24-hour">24-Hour Stay</option>
                                <option value="home-stay">Home Stay (Live-in)</option>
                                <option value="Morning">Morning (6AM-10AM)</option>
                                <option value="Afternoon">Afternoon (10AM-2PM)</option>
                                <option value="Evening">Evening (2PM-6PM)</option>
                                <option value="Flexible">Flexible Hours</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="expectedSalary" class="block text-sm font-medium text-whatsapp-text-primary">Expected Monthly Salary (NPR) *</label>
                            <select id="expectedSalary" name="expectedSalary" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Expected Salary</option>
                                <option value="6000">NPR 6,000</option>
                                <option value="8000">NPR 8,000</option>
                                <option value="10000">NPR 10,000</option>
                                <option value="12000">NPR 12,000</option>
                                <option value="14000">NPR 14,000</option>
                                <option value="16000">NPR 16,000</option>
                                <option value="18000">NPR 18,000</option>
                                <option value="20000">NPR 20,000</option>
                                <option value="22000">NPR 22,000</option>
                                <option value="24000">NPR 24,000</option>
                                <option value="26000">NPR 26,000</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Background Information -->
                <div class="space-y-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <h2 class="text-lg font-semibold text-whatsapp-text-primary pb-2 border-b border-gray-200">Background Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="nationality" class="block text-sm font-medium text-whatsapp-text-primary">Nationality *</label>
                            <select id="nationality" name="nationality" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Nationality</option>
                                <option value="Nepali">Nepali</option>
                                <option value="Indian">Indian</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="religion" class="block text-sm font-medium text-whatsapp-text-primary">Religion</label>
                            <select id="religion" name="religion"
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Religion</option>
                                <option value="Hindu">Hindu</option>
                                <option value="Buddhist">Buddhist</option>
                                <option value="Muslim">Muslim</option>
                                <option value="Christian">Christian</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="education" class="block text-sm font-medium text-whatsapp-text-primary">Education Level *</label>
                            <select id="education" name="education" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Education Level</option>
                                <option value="Under SEE">Under SEE</option>
                                <option value="SEE">SEE Pass</option>
                                <option value="Intermediate">Intermediate Pass</option>
                                <option value="Bachelor">Bachelor Pass</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <label for="documents" class="block text-sm font-medium text-whatsapp-text-primary">Available Documents *</label>
                            <select id="documents" name="documents" required
                                class="mt-1 block w-full rounded-whatsapp border-gray-300 shadow-whatsapp focus:border-whatsapp-primary focus:ring-whatsapp-primary">
                                <option value="">Select Available Documents</option>
                                <option value="Citizenship">Citizenship</option>
                                <option value="Rastriya Parichay Patra">Rastriya Parichay Patra</option>
                                <option value="Passport">Passport</option>
                                <option value="None">No Documents Available</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Languages -->
                <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-whatsapp-text-primary">Languages Spoken *</label>
                    <p class="text-xs text-whatsapp-text-secondary mb-2">Select all languages you can speak</p>
                    <div class="grid grid-cols-2 gap-2 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="languages" value="Nepali" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary">
                            <span>Nepali</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="languages" value="English" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary">
                            <span>English</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="languages" value="Hindi" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary">
                            <span>Hindi</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="languages" value="Newari" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary">
                            <span>Newari</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="languages" value="Tamang" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary">
                            <span>Tamang</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="languages" value="Gurung" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary">
                            <span>Gurung</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="languages" value="Magar" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary">
                            <span>Magar</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="languages" value="Maithili" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary">
                            <span>Maithili</span>
                        </label>
                    </div>
                </div>

                <!-- Skills -->
                <div class="space-y-4 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-whatsapp-text-primary">Skills * (Select all that matches your skills)</label>
                    <p class="text-xs text-whatsapp-text-secondary mb-4">Check all the services you can provide</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Cooking" name="skills">
                            <span>Cooking</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Cleaning" name="skills">
                            <span>Cleaning</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Laundry" name="skills">
                            <span>Laundry/Clothes Washing</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Child Care" name="skills">
                            <span>Child Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Elderly Care" name="skills">
                            <span>Elderly Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Patient Care" name="skills">
                            <span>Patient Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Pet Care" name="skills">
                            <span>Pet Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Postnatal/Sutkeri Care" name="skills">
                            <span>Postnatal/Sutkeri Care</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Office Assistant" name="skills">
                            <span>Office Assistant</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Gardening" name="skills">
                            <span>Gardening</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="rounded border-gray-300 text-whatsapp-primary focus:ring-whatsapp-primary" value="Ironing" name="skills">
                            <span>Ironing</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox" value="Dishwashing" name="skills">
                            <span>Dishwashing</span>
                        </label>
                    </div>
                </div>

                <!-- About Me -->
                <div class="section">
                    <label for="about" class="form-label">About Me *</label>
                    <div class="relative">
                        <textarea id="about" name="about" rows="4" required maxlength="250"
                            class="form-textarea"
                            placeholder="Tell employers about yourself, your experience, and what makes you a great domestic helper (max 250 characters)"></textarea>
                        <div class="absolute bottom-2 right-2 text-xs text-whatsapp-text-secondary">
                            <span id="charCount">0</span>/250
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end pt-4">
                    <button type="submit" class="btn-primary">
                        Update Profile
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://fdgqqxyyofjnkhswkwcq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3FxeHl5b2Zqbmtoc3drd2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjQyMTMsImV4cCI6MjA1OTYwMDIxM30.YyJLLu3r2a7Mh7ny0ie-YzzLfPh5PdrJJHnBFBxWqVE';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Store user globally
        let currentUser = null;

        // Setup photo preview functionality
        function setupPhotoPreview() {
            const profilePhotoInput = document.getElementById('profilePhoto');
            const profilePhotoPreview = document.getElementById('profilePhotoPreview');
            const placeholderIcon = document.getElementById('placeholderIcon');
            
            if (profilePhotoInput && profilePhotoPreview) {
                profilePhotoInput.addEventListener('change', function() {
                    const file = this.files[0];
                    if (file) {
                        // Validate file type
                        const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                        if (!validTypes.includes(file.type)) {
                            showError('Please upload a valid image file (JPEG or PNG)');
                            this.value = '';
                            return;
                        }

                        // Validate file size (max 2MB)
                        const maxSize = 2 * 1024 * 1024; // 2MB in bytes
                        if (file.size > maxSize) {
                            showError('Image size should be less than 2MB');
                            this.value = '';
                            return;
                        }

                        // Validate image dimensions
                        const img = new Image();
                        img.onload = function() {
                            if (this.width < 200 || this.height < 200) {
                                showError('Image dimensions should be at least 200x200 pixels');
                                profilePhotoInput.value = '';
                    return;
                }

                            const reader = new FileReader();
                            reader.onload = function(e) {
                                profilePhotoPreview.src = e.target.result;
                                profilePhotoPreview.style.opacity = '1';
                                placeholderIcon.style.display = 'none';
                            };
                            reader.readAsDataURL(file);
                        };
                        img.src = URL.createObjectURL(file);
                    }
                });
            }
        }

        // Setup character counter for About Me
        function setupCharCounter() {
            const aboutTextarea = document.getElementById('about');
            const charCount = document.getElementById('charCount');
            
            if (aboutTextarea && charCount) {
                aboutTextarea.addEventListener('input', function() {
                    const remaining = this.value.length;
                    charCount.textContent = remaining;
                    
                    // Add visual feedback when approaching limit
                    if (remaining > 225) {
                        charCount.classList.add('text-red-500');
                    } else {
                        charCount.classList.remove('text-red-500');
                    }
                });
            }
        }

        // Form validation function
        function validateForm() {
            // Check required fields
            const requiredFields = [
                'fullName', 'ageGroup', 'gender', 'maritalStatus', 'nationality',
                'email', 'phone', 'address', 'emergencyContact', 'experience',
                'availableFrom', 'preferredTime', 'expectedSalary'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    showError(`Please fill in the ${field.labels[0].textContent.toLowerCase()}`);
                    field.focus();
                    return false;
                }
            }
            
            // Validate email format
            const emailValue = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailValue)) {
                showError('Please enter a valid email address');
                document.getElementById('email').focus();
                return false;
            }
            
            // Validate phone number format (10 digits)
            const phoneValue = document.getElementById('phone').value;
            const phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(phoneValue)) {
                showError('Please enter a valid 10-digit phone number');
                document.getElementById('phone').focus();
                return false;
            }
            
            // Validate emergency contact format (10 digits)
            const emergencyContact = document.getElementById('emergencyContact').value;
            if (emergencyContact && !phoneRegex.test(emergencyContact)) {
                showError('Please enter a valid 10-digit emergency contact number');
                document.getElementById('emergencyContact').focus();
                return false;
            }
            
            // Check if at least one skill is selected
            const selectedSkills = document.querySelectorAll('.skill-checkbox:checked');
            if (selectedSkills.length === 0) {
                showError('Please select at least one skill');
                return false;
            }
            
            // Check if at least one language is selected
            const selectedLanguages = document.querySelectorAll('.language-checkbox:checked');
            if (selectedLanguages.length === 0) {
                showError('Please select at least one language');
                return false;
            }
            
            return true;
        }

        // Check authentication and role on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check if user is authenticated
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                
                if (authError || !user) {
                    console.error('Authentication error:', authError);
                    // Store intended destination
                    localStorage.setItem('redirectAfterAuth', window.location.href);
                    // Redirect to login with maid role pre-selected
                    window.location.href = '../auth/login.html?role=maid';
                    return;
                }

                // Store user globally
                currentUser = user;
                console.log('User authenticated:', user.id);

                // Verify user role is maid
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('role')
                    .eq('id', user.id)
                    .single();

                if (profileError) {
                    console.error('Profile error:', profileError);
                    throw profileError;
                }

                if (!profile || profile.role !== 'maid') {
                    console.error('Invalid role:', profile?.role);
                    // If user is not registered as maid, redirect to registration
                    window.location.href = '../auth/register.html?role=maid';
                    return;
                }

                console.log('Role verified as maid');

                // Load existing profile data
                const { data: maidProfile, error: maidProfileError } = await supabaseClient
                    .from('maid_profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();

                if (maidProfileError) {
                    console.error('Error loading maid profile:', maidProfileError);
                    throw maidProfileError;
                }

                console.log('Maid profile loaded:', maidProfile);

                if (maidProfile) {
                    populateForm(maidProfile);
                }

                // Initialize form functionality
                setupPhotoPreview();
                setupCharCounter();
                setupFormSubmission();

                console.log('Page initialization complete');
            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Error loading page. Please try again.');
            }
        });

        // Setup form submission
        function setupFormSubmission() {
            const form = document.getElementById('profileForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
            e.preventDefault();
                    
                    // Validate form
                    if (!validateForm()) {
                        return;
                    }

            try {
                        const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Updating...';

                        // Handle photo upload first
                        let photoUrl = null;
                        const photoFile = document.getElementById('profilePhoto').files[0];
                        if (photoFile) {
                            const fileExt = photoFile.name.split('.').pop();
                            const fileName = `${Math.random().toString(36).substring(2)}.${fileExt}`;
                            const { data: uploadData, error: uploadError } = await supabaseClient
                                .storage
                                .from('profile-photos')
                                .upload(fileName, photoFile);

                            if (uploadError) throw uploadError;
                            
                            photoUrl = fileName; // Store just the filename
                        }
                        
                        const loadingToast = showLoading('Updating profile...');

                // Collect form data
                        const formData = new FormData(form);
                const profileData = {
                            // Basic Information
                    full_name: formData.get('fullName'),
                    age_group: formData.get('ageGroup'),
                    gender: formData.get('gender'),
                    marital_status: formData.get('maritalStatus'),
                            
                            // Contact Information
                            email: formData.get('email'),
                            phone: formData.get('phone'),
                            
                            // Work Information
                            experience: formData.get('experience'),
                            available_from: formData.get('availableFrom'),
                            preferred_time: formData.get('preferredTime'),
                            expected_salary: formData.get('expectedSalary'),
                            major_city: formData.get('majorCity'),
                            specific_areas: Array.from(formData.getAll('kathmanduAreas')),
                            willing_to_travel: formData.get('willingToTravel') === 'on',
                            travel_distance: formData.get('travelDistance'),
                            
                            // Background Information
                    nationality: formData.get('nationality'),
                    religion: formData.get('religion'),
                    education: formData.get('education'),
                            documents: formData.get('documents'),
                            languages: Array.from(formData.getAll('languages')),
                            
                            // Other
                            about: formData.get('about'),
                            skills: Array.from(formData.getAll('skills')),
                            profile_photo: photoUrl
                        };
                        
                        // Update profile data
                    const { data, error } = await supabaseClient
                        .from('maid_profiles')
                        .update(profileData)
                            .eq('user_id', currentUser.id)
                            .select('id')
                            .single();
                            
                        if (error) throw error;
                        
                showSuccess('Profile updated successfully!');

                        // Redirect to dashboard after successful update
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                        console.error('Error updating profile:', error);
                        showError('Failed to update profile. Please try again.');
                    } finally {
                        const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.textContent = 'Update Profile';
            }
        });
            }
        }

        // Function to populate form with existing data
        function populateForm(profile) {
            try {
                console.log('Starting form population with profile:', profile);
                
                // Helper function to safely set form values
                const setFormValue = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value || '';
                        console.log(`Set ${id} to:`, value);
                    } else {
                        console.warn(`Element not found: ${id}`);
                    }
                };

                // Helper function to safely set checkbox values
                const setCheckboxValues = (name, values) => {
                    if (Array.isArray(values)) {
                        values.forEach(value => {
                            const checkbox = document.querySelector(`input[name="${name}"][value="${value}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                console.log(`Checked ${name} checkbox:`, value);
                            } else {
                                console.warn(`Checkbox not found: ${name} - ${value}`);
                            }
                        });
                    }
                };

                // Basic Information
                setFormValue('fullName', profile.full_name);
                setFormValue('ageGroup', profile.age_group);
                setFormValue('gender', profile.gender);
                setFormValue('maritalStatus', profile.marital_status);
                
                // Contact Information
                setFormValue('email', profile.email);
                setFormValue('phone', profile.phone);
                
                // Work Information
                setFormValue('experience', profile.experience);
                setFormValue('availableFrom', profile.available_from);
                setFormValue('preferredTime', profile.preferred_time);
                setFormValue('expectedSalary', profile.expected_salary);
                setFormValue('majorCity', profile.major_city);
                
                // Background Information
                setFormValue('nationality', profile.nationality);
                setFormValue('religion', profile.religion);
                setFormValue('education', profile.education);
                setFormValue('documents', profile.documents);
                
                // Languages
                setCheckboxValues('languages', profile.languages);
                
                // Skills
                setCheckboxValues('skills', profile.skills);
                
                // About Me
                setFormValue('about', profile.about);
                
                // Profile Photo
                if (profile.profile_photo) {
                    const photoUrl = `${supabaseUrl}/storage/v1/object/public/profile-photos/${profile.profile_photo}`;
                    const photoPreview = document.getElementById('profilePhotoPreview');
                    const placeholderIcon = document.getElementById('placeholderIcon');
                    
                    if (photoPreview && placeholderIcon) {
                        photoPreview.src = photoUrl;
                        photoPreview.style.opacity = '1';
                        placeholderIcon.style.display = 'none';
                        console.log('Profile photo set to:', photoUrl);
                    } else {
                        console.warn('Photo preview elements not found');
                    }
                }

                console.log('Form population completed successfully');
            } catch (error) {
                console.error('Error populating form:', error);
                showError('Error loading profile data. Please refresh the page.');
            }
        }

        // Show loading message
        function showLoading(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded z-50 flex items-center space-x-2';
            toast.innerHTML = `
                <i class="fas fa-spinner fa-spin"></i>
                <span class="block sm:inline">${message}</span>
            `;
            document.body.appendChild(toast);
            return toast;
        }

        // Show success message
        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50 flex items-center space-x-2';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span class="block sm:inline">${message}</span>
            `;
            document.body.appendChild(alert);
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s ease-in-out';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }

        // Show error message
        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50 flex items-center space-x-2';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span class="block sm:inline">${message}</span>
            `;
            document.body.appendChild(alert);
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s ease-in-out';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }
    </script>
</body>
</html> 